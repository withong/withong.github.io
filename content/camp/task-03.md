+++
title = "[내일배움캠프] 과제 - 계산기 3"
date = "2025-03-05T22:00:00+09:00"
draft = "false"
topic = ["camp"]
tag = ["내일배움캠프", "TIL", "과제"]
+++

## 요구사항
Enum, 제네릭, 람다 & 스트림을 이해한 계산기 만들기

- **현재 사칙연산 계산기는 (➕,➖,✖️,➗) 이렇게 총 4가지 연산 타입으로 구성되어 있습니다.**
    - Enum 타입을 활용하여 연산자 타입에 대한 정보를 관리하고 이를 사칙연산 계산기 ArithmeticCalculator 클래스에 활용 해봅니다.

- **실수, 즉 double 타입의 값을 전달 받아도 연산이 수행하도록 만들기**
    - 키워드 : `제네릭`
        - 단순히, 기존의 Int 타입을 double 타입으로 바꾸는 게 아닌 점에 주의하세요!
    - 지금까지는 ArithmeticCalculator, 즉 사칙연산 계산기는 양의 정수(0 포함)를 매개변수로 전달받아 연산을 수행
    - 피연산자를 여러 타입으로 받을 수 있도록 기능을 확장
        - ArithmeticCalculator 클래스의 연산 메서드(`calculate`)
    - 위 요구사항을 만족할 수 있도록 ArithmeticCalculator 클래스를 수정합니다. (제네릭)
        - 추가적으로 수정이 필요한 다른 클래스나 메서드가 있다면 같이 수정 해주세요.

- **저장된 연산 결과들 중 Scanner로 입력받은 값보다 큰 결과값 들을 출력**
    - ArithmeticCalculator 클래스에 위 요구사항을 만족하는 조회 메서드를 구현합니다.
    - 단, 해당 메서드를 구현할 때 Lambda & Stream을 활용하여 구현합니다.

---

## 파일 구조

| 파일명 | 패키지 | 역할 |
|--------|--------|------|
| `App.java` | `calculator.level3.ui` | 프로그램 실행 및 메뉴 제공 |
| `InputValidator.java` | `calculator.level3.ui` | 사용자 입력 검증 |
| `Operand.java` | `calculator.level3.model` | 피연산자(`BigDecimal` 변환 포함) |
| `Operator.java` | `calculator.level3.model` | 연산자(+, -, *, /) 및 연산 수행 |
| `CalculationRecord.java` | `calculator.level3.model` | 연산 기록 저장 객체 |
| `ArithmeticCalculator.java` | `calculator.level3.service` | 실제 계산 수행 및 기록 관리 |
| `CalculatorException.java` | `calculator.level3.exception` | 예외 처리 클래스 |

---

## 기능 구현
[# 전체 코드](https://github.com/withong/nbc-chapter-02/tree/main/calculator/level3)

### App
- **`main(String[] args)`**

  - 메뉴 번호를 입력받아 처리
  - `1` 입력 시 피연산자 2개, 연산자 입력받고 연산 수행
  - `2` 입력 시 연산 기록 조회
  - `3` 입력 시 기록 선택/전체 삭제
  - `4` 입력 시 결과 검색(특정 값보다 큰/작은/같은 결과)
  - `5` 입력 시 프로그램 종료
  - 잘못된 메뉴 번호는 예외 발생
  - 모든 예외는 catch 후 메시지 출력

<br>

### InputValidator
- **`getValidInt()`**
  - 메뉴 번호를 입력받음
  - 빈 값이면 예외 발생
  - 숫자가 아닌 문자가 섞여 있으면 예외 발생
  - 정상 정수면 int로 파싱해 반환
  
- **`getValidNumber(String message)`**
  - 사용자 입력받음
  - 빈 값이면 예외 발생
  - 숫자로 변환 불가능하면 예외 발생
  - BigDecimal로 변환 후 Operand<BigDecimal\> 형태로 감싸 반환

- **`getValidOperator()`**
  - 연산자 입력받음
  - 빈 값이면 예외 발생
  - `+` `-` `*` `/` 중 하나가 아니면 예외 발생
  - 해당 기호의 Operator enum을 찾아 반환

- **`selectRecordsWhere(ArithmeticCalculator calculator)`**
  - 메뉴 번호와 기준 값을 입력받아 처리
  - `1` 기준 값보다 큰 연산 결과 검색
  - `2` 기준 값보다 작은 연산 결과 검색
  - `3` 기준 값과 일치하는 연산 결과 검색
  - 빈 값이면 메서드 즉시 종료(취소 처리 → null 반환)
  - BigDecimal 변환 후, calculator.getRecords()를 스트림으로 순회
  - result를 toBigDecimal() 한 뒤 기준값과 비교
  - 조건(`>` `<` `=`) 만족하는 기록만 필터링하여 반환

- **`selectRecordToRemove(ArithmeticCalculator calculator)`**
  - 목록을 보여주고, 삭제할 기록 번호나 all을 입력받음
  - 빈 값이면 취소 후 메서드 종료
  - all이면 전체 삭제 후 종료
  - 정상 범위 번호면 해당 인덱스의 기록을 삭제
  - 숫자가 아니거나 없는 메뉴 번호면 예외 발생

- **`isNumber(String str)`**
  - 전달받은 문자열이 BigDecimal로 파싱 가능한지 시도
  - 성공하면 true, 실패하면 false

- **`toBigDecimal(Operand<?> operand)`**
  - Operand의 getOperand()로 값을 꺼낸 뒤 BigDecimal로 변환
  - 숫자가 아니면 예외 발생
  - 변환 후 stripTrailingZeros

<br>

### Operand

- **`Operand(T operand)`**
  - 피연산자 값을 입력받아 내부 필드에 저장
  
- **`getOperand()`**
  - 내부에 저장된 피연산자 값을 그대로 반환
  
- **`toBigDecimal()`**

  - 내부 값이 BigDecimal 타입인지 확인
  - BigDecimal이면 그 값을 반환
  - 그렇지 않으면 예외 발생
  
- **`toString()`**
  - operand.toString() 결과를 반환

<br>

### Operator
- **`Operator(String symbol)`**
  - Enum 생성자
  - `+` `-` `*` `/` 등 기호를 symbol로 저장

- **`apply(Operand<?> number1, Operand<?> number2)`**
  - 두 피연산자의 toBigDecimal()을 호출해 BigDecimal로 변환
  - 연산자 유형에 따라 add, subtract, multiply, divide 수행
  - divide 시 분모가 0이면 CalculatorException 발생
  - 연산 결과(BigDecimal) 반환

<br>

### CalculationRecord
- **`CalculationRecord(Operand<?> number1, Operator operator, Operand<?> number2, Operand<?> result)`**
  - 연산에 사용된 피연산자 2개, 연산자, 결과를 입력받아 저장

- **`getResult()`**
  - 연산 결과 반환

- **`toString()`**
  - [ number1 operator number2 = result ] 형태의 문자열 반환

<br>

### ArithmeticCalculator
- **`ArithmeticCalculator()`**
  - 내부 List<CalculationRecord\> records 초기화

- **`calculate(Operand<?> number1, Operator operator, Operand<?> number2)`**
  - operator.apply(number1, number2) 호출로 BigDecimal 연산 수행
  - 예외 발생 시(0으로 나누기) "정의되지 않음" 문자열을 결과로 처리
  - 정상 결과면 formatOperand(BigDecimal)로 포맷팅
  - updateRecord(...)로 기록을 저장한 뒤 결과 반환

- **`getRecords()`**
  - records 리스트를 반환

- **`removeRecord(int index)`**
  - 해당 인덱스의 기록을 제거

- **`clearRecords()`**
  - records 리스트를 비움

- **`updateRecord(Operand<?> number1, Operator operator, Operand<?> number2, Operand<?> result)`**
  - records 리스트에 추가

- **`formatOperand(BigDecimal result)`**
  - BigDecimal을 문자열로 변환(정수, 소수점 8자리, 과학적 표기 등)
  - 변환된 문자열을 Operand<String\> 형태로 감싸 반환

- **`useScientificNotation(BigDecimal bigDecimal)`**
  - 연산 결과에 과학적 표기법을 적용할 건지 검사
  - 10자리 이상의 정수 또는 소수점 이하가 8자리 이상이면 true

<br>

### CalculatorException
- **`CalculatorException(Type type)`**
  - 예외 유형을 입력받아 내부 필드에 저장

- **`getMessage()`**
  - Type에 따라 다른 메시지 반환
  - enum 내부에 Type 정의
    - **EMPTY_VALUE** → "*\** 입력된 값이 없습니다. ***"
    - **INVALID_NUMBER** → "*\** 유효하지 않은 숫자입니다. ***"
    - **INVALID_OPERATOR** → "*\** 유효하지 않은 연산자입니다. ***"
    - **DIVISION_BY_ZERO** → "*\** 0으로 나눌 수 없습니다. ***"

---

## 문제 및 해결

<br>

### 타입 변환 및 연산 과정
- **문제**
  - 초기 설계 - Operand<T\>를 정의하여 입력값을 검증한 후 **적절한 타입(Integer, Long, Double)**으로 변환. Integer, Long, Double을 지원하며, 혼합 연산 시 Double로 변환하여 연산.
<br>
  - 타입 변환 과정
    - 소수 입력 → Operand<Double\>
    - int 범위 → Operand<Integer\>
    - int 초과 long 범위 → Operand<Long\>
    - long 초과 → Operand<Double\>
<br>    
  - Double 연산 시 부동소수점 오차 발생
  - Operand<Integer\>, Operand<Long\>를 받아서 Operand<Double\>로 변환하는 코드가 중복됨 → Integer, Long을 Double로 변환하여 연산할 때 매 연산마다 Double.parseDouble()을 사용하여 변환해야 함.
    
- **분석**
  - Double 연산 시 부동소수점 오차를 해결할 수 있는 방법은?
  → BigDecimal을 사용하여 연산 수행  
  → BigDecimal은 부동소수점 오차 없이 정확한 연산이 가능.  
  
- **해결 및 개선**
  - 모든 숫자를 Operand<BigDecimal\>로 변환하여 저장, 연산 시에도 BigDecimal을 사용.
  - 0으로 나누기 연산 오류 시 Operand<String\>으로 "정의되지 않음" 문자열 저장.

- **결과**
  - 연산 과정에서 발생하는 부동소수점 오차 해결
  - 모든 숫자를 BigDecimal로 통일하여 변환 과정 단순화
  - 연산 메서드에서 Double 변환 없이 BigDecimal 연산 수행 가능

<br>

### 과학적 표기법
- **문제**
  - **소수점 8자리 포맷팅 + 과학적 표기법 동시 사용 이슈** - 처음에는 DecimalFormat("0.########")로 8자리까지 소수점을 유지하려 했지만, 큰 수(예: 1.685644e9)에서는 **_아이폰 계산기_**처럼 1.685644e9 형태가 나오길 기대했으나, 실제 출력은 1.68564381645E9처럼 오차가 생기거나 소수 자릿수가 달라지는 문제가 발생.

  - **반올림 문제** - DecimalFormat("0.######E0")를 쓰면 과학적 표기법 적용은 되지만, 소수점 이하가 0이면 정수형처럼 보이지 않거나, 소수점 자리가 의도치 않게 잘려서 반올림이 강제로 적용됨.

  - **부동소수점(Double) 오차 누적** - 소수점 8자리로 맞춘 뒤에도, 내부에서 Double 변환이 섞여 있으면 “불필요한 자리수(0.30000000004 등)”가 생기는 문제가 계속 발생.

- **분석**
  - Double 부동소수점 오차가 핵심 원인.
    - “0.30000000000000004” 등의 현상이 발생할 수 있고, 포맷팅 시에도 예기치 않은 자릿수로 반올림되는 경우가 있음.
  - DecimalFormat만으로는 한계가 존재.
    - 큰 수(소수점 이상 10자리 이상)나 소수점 이하 자릿수(8자리 이상)에서 원하는 대로 과학적 표기법을 적용하려면, 별도의 로직이나 세밀한 설정이 필요함.
  - BigDecimal을 직접 사용해야 “소수점 N자리에서 정밀하게 반올림” + “원하지 않는 0 제거(stripTrailingZeros)” 등의 제어가 가능.

- **해결 및 개선**
  - BigDecimal으로 연산
    - 중간에 Double를 거치지 않고, 입력부터 BigDecimal로 받음.
    - setScale(8, RoundingMode.HALF_UP)로 소수점 8자리 기준 반올림 후, stripTrailingZeros()로 불필요한 0 제거.

  - 과학적 표기법 적용 조건을 명시적으로 구현
    - “소수점 이상 10자리 또는 소수점 이하 8자리 이상이면 과학적 표기법을 적용” 하는 식으로, 직접 기준을 잡아 로직 작성.
    - 과학적 표기법 시에는 DecimalFormat("0.######E0")를 사용하되, 정수 형태(소수점 이하가 0)로 보일 때는 일반 포맷(#.########)을 사용하도록 분기.
    
  - Double 변환 제거
    - 최종 결과를 다시 Double로 변환하지 않고, 문자열 상태로(Operand<>(formatted)) 반환해 최종 출력. 

- **결과**
  - 큰 수에서 1.685644e9처럼 표현되고, 일반 범위에서는 123.45678912처럼 8자리까지만 유지하는 등 원하는 형식대로 출력 가능.

---

## 실행 예시

<br>

### 정상 실행 예시
```
--------- 계산기 Version 3.0 ---------
[1] 연산하기
[2] 연산 기록 조회하기
[3] 연산 기록 삭제하기
[4] 연산 결과 검색하기
[5] 종료하기
-------------------------------------
* 메뉴 번호를 입력하세요: 1
-------------------------------------
* 첫 번째 숫자를 입력하세요: 123
* 사용할 연산자를 입력하세요: +
* 두 번째 숫자를 입력하세요: 456
-------------------------------------
[ 123 + 456 = 579 ]
-------------------------------------
[1] 연산하기
[2] 연산 기록 조회하기
[3] 연산 기록 삭제하기
[4] 연산 결과 검색하기
[5] 종료하기
-------------------------------------
* 메뉴 번호를 입력하세요: 1
-------------------------------------
* 첫 번째 숫자를 입력하세요: 12345.15
* 사용할 연산자를 입력하세요: *
* 두 번째 숫자를 입력하세요: 136543
-------------------------------------
[ 12345.15 * 136543 = 1.685644e9 ]
-------------------------------------
[1] 연산하기
[2] 연산 기록 조회하기
[3] 연산 기록 삭제하기
[4] 연산 결과 검색하기
[5] 종료하기
-------------------------------------
* 메뉴 번호를 입력하세요: 2
-------------------------------------
[1] [ 123 + 456 = 579 ]
[2] [ 12345.15 * 136543 = 1.685644e9 ]
-------------------------------------
[1] 연산하기
[2] 연산 기록 조회하기
[3] 연산 기록 삭제하기
[4] 연산 결과 검색하기
[5] 종료하기
-------------------------------------
* 메뉴 번호를 입력하세요: 3
-------------------------------------
[1] [ 123 + 456 = 579 ]
[2] [ 12345.15 * 136543 = 1.685644e9 ]
-------------------------------------
* 삭제할 기록의 번호를 입력하세요.
[취소: enter][전체: all 입력] 1
***** 계산 기록이 삭제되었습니다. *****
-------------------------------------
[1] 연산하기
[2] 연산 기록 조회하기
[3] 연산 기록 삭제하기
[4] 연산 결과 검색하기
[5] 종료하기
-------------------------------------
* 메뉴 번호를 입력하세요: 4
-------------------------------------
[1] 보다 큰 값 검색하기
[2] 보다 작은 값 검색하기
[3] 일치하는 값 검색하기
-------------------------------------
* 메뉴 번호를 입력하세요. [취소: enter] 1
* 기준 값을 입력하세요: 1.685644e8
-------------------------------------
[1] [ 12345.15 * 136543 = 1.685644e9 ]
-------------------------------------
[1] 연산하기
[2] 연산 기록 조회하기
[3] 연산 기록 삭제하기
[4] 연산 결과 검색하기
[5] 종료하기
-------------------------------------
* 메뉴 번호를 입력하세요: 5
------------- 계산기 종료 -------------
```

<br>

### 예외 실행 예시
```
-------------------------------------
[1] 연산하기
[2] 연산 기록 조회하기
[3] 연산 기록 삭제하기
[4] 연산 결과 검색하기
[5] 종료하기
-------------------------------------
* 메뉴 번호를 입력하세요: 6
***** 유효하지 않은 숫자입니다. *****
-------------------------------------
```
```
-------------------------------------
* 첫 번째 숫자를 입력하세요: 1
* 사용할 연산자를 입력하세요: 2
***** 유효하지 않은 연산자입니다. *****
-------------------------------------
```
```
-------------------------------------
* 메뉴 번호를 입력하세요: 
***** 입력된 값이 없습니다. *****
-------------------------------------
```
```
-------------------------------------
* 첫 번째 숫자를 입력하세요: 99
* 사용할 연산자를 입력하세요: /
* 두 번째 숫자를 입력하세요: 0
***** 0으로 나눌 수 없습니다. *****
-------------------------------------
[ 99 / 0 = 정의되지 않음 ]
-------------------------------------
```
```
-------------------------------------
[1] [ 1 + 1 = 2 ]
[2] [ 2 + 2 = 4 ]
[3] [ 3 + 3 = 6 ]
[4] [ 4 + 4 = 8 ]
[5] [ 5 + 5 = 10 ]
[6] [ 99 / 0 = 정의되지 않음 ]
[7] [ 1 - 5 = -4 ]
[8] [ -9 * 40 = -360 ]
-------------------------------------
* 삭제할 기록의 번호를 입력하세요.
[취소: enter][전체: all 입력] 9
***** 유효하지 않은 숫자입니다. *****
-------------------------------------
```
```
-------------------------------------
[1] 연산하기
[2] 연산 기록 조회하기
[3] 연산 기록 삭제하기
[4] 연산 결과 검색하기
[5] 종료하기
-------------------------------------
* 메뉴 번호를 입력하세요: 4
-------------------------------------
[1] 보다 큰 값 검색하기
[2] 보다 작은 값 검색하기
[3] 일치하는 값 검색하기
-------------------------------------
* 메뉴 번호를 입력하세요. [취소: enter] 4
***** 유효하지 않은 숫자입니다. *****
-------------------------------------
```

